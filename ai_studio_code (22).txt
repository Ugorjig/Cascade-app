import React, { useMemo, useState } from 'react';
import type { User } from '../types.ts';
import { VerifiedIcon, BackIcon } from '../constants.tsx';

interface FollowersPageProps {
  currentUser: User;
  allUsers: User[];
  onBack: () => void;
  handleViewProfile: (userId: string) => void;
  handleFollow: (userId: string) => void;
}

const UserRow: React.FC<{
    user: User;
    currentUser: User;
    isFollowing: boolean;
    onFollow: (userId: string) => void;
    onViewProfile: (userId: string) => void;
}> = ({ user, currentUser, isFollowing, onFollow, onViewProfile }) => {
    const [isHovering, setIsHovering] = useState(false);

    return (
        <div className="flex items-center justify-between p-4 border-b border-border dark:border-dark-border hover:bg-surface-hover dark:hover:bg-dark-surface-hover transition-colors duration-200">
            <button onClick={() => onViewProfile(user.id)} className="flex items-center gap-4 flex-1 min-w-0 text-left">
                <img src={user.avatarUrl} alt={user.name} className="w-12 h-12 rounded-full flex-shrink-0" />
                <div className="min-w-0">
                    <div className="flex items-center gap-1">
                        <p className="font-bold truncate">{user.name}</p>
                        {user.verificationStatus === 'verified' && <VerifiedIcon className="w-4 h-4 text-primary flex-shrink-0" />}
                    </div>
                    <p className="text-on-surface-secondary dark:text-dark-on-surface-secondary truncate">{user.handle}</p>
                    {user.bio && <p className="text-sm text-on-surface dark:text-dark-on-surface truncate mt-1">{user.bio}</p>}
                </div>
            </button>
            {user.id !== currentUser.id && (
                 <button
                    onClick={() => onFollow(user.id)}
                    onMouseEnter={() => setIsHovering(true)}
                    onMouseLeave={() => setIsHovering(false)}
                    className={`font-bold text-sm px-4 py-2 rounded-full transition-colors duration-200 flex-shrink-0 ${
                    isFollowing
                        ? 'bg-surface dark:bg-dark-surface text-on-surface dark:text-dark-on-surface border border-border dark:border-dark-border hover:bg-red-50 dark:hover:bg-red-900/50 hover:text-red-600 hover:border-red-300'
                        : 'bg-on-surface dark:bg-dark-on-surface text-background dark:text-dark-background hover:bg-on-surface/90 dark:hover:bg-dark-on-surface/90'
                    }`}
                >
                    {isFollowing ? (isHovering ? 'Unfollow' : 'Following') : 'Follow'}
                </button>
            )}
        </div>
    );
};


const FollowersPage: React.FC<FollowersPageProps> = ({ currentUser, allUsers, onBack, handleViewProfile, handleFollow }) => {
    
    const followers = useMemo(() => {
        return allUsers.filter(u => u.followingIds?.includes(currentUser.id));
    }, [allUsers, currentUser.id]);

    const currentUserFollowingIds = currentUser.followingIds || [];

    return (
        <div className="w-full min-h-screen">
            <div className="sticky top-0 bg-background/80 dark:bg-dark-background/80 backdrop-blur-md z-10 px-4 py-3 border-b border-border dark:border-dark-border flex items-center gap-4">
                <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-surface-hover dark:hover:bg-dark-surface-hover">
                    <BackIcon className="w-6 h-6" />
                </button>
                <div>
                    <h1 className="text-xl font-bold">Followers</h1>
                    <p className="text-sm text-on-surface-secondary dark:text-dark-on-surface-secondary">{currentUser.handle}</p>
                </div>
            </div>
            
            <div>
                {followers.length > 0 ? (
                    followers.map(listUser => (
                        <UserRow
                            key={listUser.id}
                            user={listUser}
                            currentUser={currentUser}
                            isFollowing={currentUserFollowingIds.includes(listUser.id)}
                            onFollow={handleFollow}
                            onViewProfile={handleViewProfile}
                        />
                    ))
                ) : (
                    <div className="p-8 text-center text-on-surface-secondary dark:text-dark-on-surface-secondary">
                        <p className="font-bold text-xl">
                            You don't have any followers yet.
                        </p>
                        <p>
                            When someone follows you, they'll be listed here.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default FollowersPage;